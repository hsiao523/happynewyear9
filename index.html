<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta property="og:title" content="é»æˆ‘åˆ®å¤§çï¼è²¡ç¥é»ååˆ®åˆ®æ¨‚">
    <meta property="og:description" content="çœ‹çœ‹å“ªå€‹é–‹é‹å°ç‰©å‡ºç¾æœ€å¤šæ¬¡ï¼Ÿ">
    <meta property="og:image" content="https://hsiao523.github.io/happynewyear9/title.jpg">
    <title>è²¡ç¥é»ååˆ®åˆ®æ¨‚</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        * {
            box-sizing: border-box;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
        }

        body {
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            /* èƒŒæ™¯åœ–è¨­å®š */
            background: url('https://hsiao523.github.io/happynewyear9/background.jpg') no-repeat center center;
            background-size: cover;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            overflow: hidden;
            touch-action: none; /* é˜²æ­¢æ‰‹æ©Ÿä¸‹æ»‘é‡æ•´ */
            font-family: "Microsoft JhengHei", sans-serif;
        }

        /* ä¹å®®æ ¼å®¹å™¨ */
        .grid-container {
            display: grid;
            grid-template-columns: repeat(3, 90px);
            grid-template-rows: repeat(3, 80px);
            gap: 6px;
            padding: 15px;
            margin-top: 52vh; /* æ§åˆ¶å‚ç›´ä½ç½® */
            background: rgba(0, 0, 0, 0.1); 
            border-radius: 15px;
            position: relative;
        }

        .scratch-card {
            position: relative;
            width: 90px;
            height: 80px;
            background: #fff3e0;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.2rem;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
        }

        /* é‡‘ç²‰ç‰¹æ•ˆå±¤ */
        .particle-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 3;
        }

        /* åˆ®åˆ®æ¨‚éŠ€æ¼†å±¤ */
        .scratch-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            cursor: crosshair;
            touch-action: none;
            border-radius: 10px;
            transition: opacity 0.4s ease;
            z-index: 2;
        }

        /* çµæœå½ˆçª— */
        #result-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.98);
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 0 40px rgba(0,0,0,0.6);
            z-index: 1000;
            text-align: center;
            width: 85%;
            max-width: 320px;
            border: 5px solid #d32f2f;
        }

        #modal-title { color: #d32f2f; font-size: 1.5rem; margin-bottom: 10px; font-weight: bold; }
        #modal-text { font-size: 1.3rem; font-weight: bold; line-height: 1.6; color: #333; margin-bottom: 20px; }
        
        /* æŒ‰éˆ•å…±ç”¨æ¨£å¼ */
        .modal-btn { 
            color: white; 
            border: none; 
            padding: 12px 25px; 
            border-radius: 50px; 
            font-size: 1.1rem; 
            cursor: pointer; 
            font-weight: bold; 
            margin: 5px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }

        /* å†ç©ä¸€æ¬¡æŒ‰éˆ• (ç´…è‰²) */
        .btn-restart { background: #d32f2f; }
        
        /* åˆ†äº«æŒ‰éˆ• (LINE ç¶ è‰²) */
        .btn-share { background: #06c755; }
    </style>
</head>
<body>

    <div class="grid-container" id="grid"></div>

    <div id="result-modal">
        <div id="modal-emoji" style="font-size: 3.5rem; margin-bottom: 10px;">ğŸŠ</div>
        <div id="modal-title">è²¡ç¥å ±å–œ</div>
        <div id="modal-text"></div>
        <div id="btn-container">
            <button class="modal-btn btn-restart" onclick="closeModal()">å†ç©ä¸€æ¬¡</button>
            </div>
    </div>

    <script>
        // ==========================================
        // âš ï¸ é‡è¦ï¼šè«‹åœ¨æ­¤å¡«å…¥æ‚¨çš„ LIFF ID
        // ==========================================
        const MY_LIFF_ID = "è«‹åœ¨æ­¤å¡«å…¥æ‚¨çš„LIFF_ID"; 
        // ä¾‹å¦‚: const MY_LIFF_ID = "1657801234-AbCdEfGh";

        // ä¸€èˆ¬è³€è© (åªå¯«å¾ŒåŠæ®µï¼Œç¨‹å¼æœƒè‡ªå‹•åŠ ä¸Š "åˆ®ä¸­Nå€‹...")
        const normalMap = {
            'ğŸ’°': "ä»Šå¹´è³ºå¤§éŒ¢ï¼",
            'ğŸ§§': "ä»Šå¹´ç´…åˆ©é ˜ä¸å®Œï¼",
            'ğŸ’': "é‡‘éŠ€ç å¯¶æ»¿åé–“ï¼",
            'ğŸŠ': "å¤§å‰å¤§åˆ©ç™¼å¤§è²¡ï¼",
            'âœ¨': "ä»Šå¹´é‹å‹¢äº®æ™¶æ™¶ï¼",
            'ğŸ': "ä»Šå¹´å¹´é ­æ—ºåˆ°å¹´å°¾ï¼",
            'ğŸ§¨': "å¤©å¤©ä¸­å¤§çï¼Œé•ç‚®éŸ¿ä¸åœï¼"
        };

        // çµ‚æ¥µè³€è© (9å€‹å…¨ä¸­)
        const superMap = {
            'ğŸ’°': "ã€çµ‚æ¥µè²¡ç¥ã€‘9å€‹ğŸ’°å…¨é–‹ï¼å¯Œç”²å¤©ä¸‹ï¼",
            'ğŸ§§': "ã€ç´…åŒ…ä¹‹ç‹ã€‘9å€‹ğŸ§§å…¨é–‹ï¼è²¡åº«æ»¿ç›ˆï¼",
            'ğŸ’': "ã€è‡³å°Šç å¯¶ã€‘9å€‹ğŸ’å…¨é–‹ï¼å¯Œè²´ä¸€ç”Ÿï¼",
            'ğŸŠ': "ã€è¶…ç´šå¤§å‰ã€‘9å€‹ğŸŠå…¨é–‹ï¼è¬äº‹å¤§äº¨é€šï¼",
            'âœ¨': "ã€ç¥å…‰æ™®ç…§ã€‘9å€‹âœ¨å…¨é–‹ï¼é‹å‹¢ç„¡æ•µå¼·ï¼",
            'ğŸ': "ã€è¶…ç´šæ—ºä¾†ã€‘9å€‹ğŸå…¨é–‹ï¼å¥½é‹çˆ†æ£šäº†ï¼",
            'ğŸ§¨': "ã€å¤§çè‡¨é–€ã€‘9å€‹ğŸ§¨å…¨é–‹ï¼é©šå–œé€£é€£ç™¼ï¼"
        };

        const gridElement = document.getElementById('grid');
        const modal = document.getElementById('result-modal');
        const modalText = document.getElementById('modal-text');
        
        let clearedCount = 0;
        let winner = { symbol: '', count: 0 };

        // --- LIFF åˆå§‹åŒ– ---
        function initializeLiff() {
            liff.init({ liffId: MY_LIFF_ID })
                .then(() => {
                    // è‹¥æœªç™»å…¥ï¼Œå‰‡åŸ·è¡Œç™»å…¥
                    if (!liff.isLoggedIn()) {
                        liff.login();
                    }
                })
                .catch((err) => {
                    console.error('LIFF Init failed:', err);
                });
        }

        // --- LINE åˆ†äº«åŠŸèƒ½ ---
        function sendShare() {
            if (liff.isApiAvailable('shareTargetPicker')) {
                liff.shareTargetPicker([
                    {
                        'type': 'flex',
                        'altText': 'è²¡ç¥çˆºç™¼ç´…åŒ…å•¦ï¼å¿«ä¾†åˆ®åˆ®çœ‹ï¼',
                        'contents': {
                            'type': 'bubble',
                            'hero': {
                                'type': 'image',
                                'url': 'https://hsiao523.github.io/happynewyear9/title.jpg',
                                'size': 'full',
                                'aspectRatio': '20:13',
                                'aspectMode': 'cover',
                                'action': { 'type': 'uri', 'uri': 'https://liff.line.me/' + MY_LIFF_ID }
                            },
                            'body': {
                                'type': 'box',
                                'layout': 'vertical',
                                'contents': [
                                    { 'type': 'text', 'text': 'ğŸ’° è²¡ç¥é»ååˆ®åˆ®æ¨‚', 'weight': 'bold', 'size': 'xl', 'color': '#d32f2f' },
                                    { 'type': 'text', 'text': `æˆ‘å‰›å‰›åˆ®ä¸­äº† ${winner.count} å€‹ ${winner.symbol}ï¼\nå¿«ä¾†çœ‹çœ‹ä½ èƒ½åˆ®ä¸­ä»€éº¼ï¼Ÿ`, 'wrap': true, 'color': '#666666', 'margin': 'md' }
                                ]
                            },
                            'footer': {
                                'type': 'box',
                                'layout': 'vertical',
                                'spacing': 'sm',
                                'contents': [
                                    {
                                        'type': 'button',
                                        'style': 'primary',
                                        'height': 'sm',
                                        'action': { 'type': 'uri', 'label': 'é¦¬ä¸Šåˆ®ä¸€å¼µ', 'uri': 'https://liff.line.me/' + MY_LIFF_ID },
                                        'color': '#d32f2f'
                                    }
                                ]
                            }
                        }
                    }
                ])
                .then((res) => {
                    if (res) console.log('åˆ†äº«æˆåŠŸ');
                })
                .catch((err) => {
                    console.log('åˆ†äº«å¤±æ•—', err);
                    alert('åˆ†äº«åŠŸèƒ½åªèƒ½åœ¨ LINE App ä¸­ä½¿ç”¨å–”ï¼');
                });
            } else {
                alert('è«‹åœ¨ LINE App ä¸­é–‹å•Ÿæ­¤éŠæˆ²æ‰èƒ½åˆ†äº«å–”ï¼');
            }
        }

        // --- é‡‘ç²‰ç²’å­ç‰¹æ•ˆé¡åˆ¥ ---
        class Particle {
            constructor(x, y) {
                this.x = x; this.y = y;
                this.size = Math.random() * 3 + 1;
                this.speedX = Math.random() * 2 - 1;
                this.speedY = Math.random() * 2 - 1;
                this.color = `rgba(255, ${215 + Math.random() * 40}, 0, ${Math.random() * 0.8 + 0.2})`;
                this.life = 1;
            }
            update() { this.x += this.speedX; this.y += this.speedY; this.life -= 0.02; }
            draw(ctx) { ctx.fillStyle = this.color; ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fill(); }
        }

        // --- éŠæˆ²åˆå§‹åŒ– ---
        function initGame() {
            gridElement.innerHTML = '';
            clearedCount = 0;
            modal.style.display = 'none';

            // ç§»é™¤èˆŠçš„åˆ†äº«æŒ‰éˆ•(å¦‚æœæœ‰)ï¼Œé¿å…é‡è¤‡
            const oldShareBtn = document.getElementById('share-btn');
            if (oldShareBtn) oldShareBtn.remove();

            const keys = Object.keys(normalMap);
            // è¨­å®šæ•¸é‡æ©Ÿç‡ï¼š5, 6, 8, æˆ– 9
            const countsToPick = [5, 6, 8, 9];
            const targetCount = countsToPick[Math.floor(Math.random() * countsToPick.length)];
            const targetSymbol = keys[Math.floor(Math.random() * keys.length)];
            
            winner = { symbol: targetSymbol, count: targetCount };

            let board = new Array(9).fill(null);
            let indices = [0,1,2,3,4,5,6,7,8].sort(() => Math.random() - 0.5);
            
            // å¡«å…¥ä¸­çç¬¦è™Ÿ
            for(let i=0; i < targetCount; i++) {
                board[indices[i]] = targetSymbol;
            }

            // å¡«å…¥é›œè¨Šç¬¦è™Ÿ
            for(let i=0; i<9; i++) {
                if(board[i] === null) {
                    let randomSym;
                    do {
                        randomSym = keys[Math.floor(Math.random() * keys.length)];
                    } while (randomSym === targetSymbol);
                    board[i] = randomSym;
                }
            }
            board.forEach(sym => createScratchCard(sym));
        }

        // --- å»ºç«‹åˆ®åˆ®å¡ ---
        function createScratchCard(symbol) {
            const card = document.createElement('div');
            card.className = 'scratch-card';
            card.innerHTML = `<span>${symbol}</span>`;

            const pCanvas = document.createElement('canvas');
            pCanvas.className = 'particle-canvas';
            const pCtx = pCanvas.getContext('2d');
            
            const sCanvas = document.createElement('canvas');
            sCanvas.className = 'scratch-canvas';
            const sCtx = sCanvas.getContext('2d');

            card.appendChild(pCanvas);
            card.appendChild(sCanvas);
            gridElement.appendChild(card);

            pCanvas.width = sCanvas.width = 90;
            pCanvas.height = 80;

            const gradient = sCtx.createLinearGradient(0, 0, 90, 80);
            gradient.addColorStop(0, '#C0C0C0');
            gradient.addColorStop(1, '#A9A9A9');
            sCtx.fillStyle = gradient;
            sCtx.fillRect(0, 0, 90, 80);

            let particles = [];
            let isDrawing = false;
            let isRemoved = false;

            function animate() {
                pCtx.clearRect(0, 0, 90, 80);
                particles.forEach((p, i) => {
                    p.update(); p.draw(pCtx);
                    if (p.life <= 0) particles.splice(i, 1);
                });
                if (!isRemoved || particles.length > 0) requestAnimationFrame(animate);
            }
            animate();

            function scratch(e) {
                if (!isDrawing || isRemoved) return;
                const rect = sCanvas.getBoundingClientRect();
                const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
                const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
                for (let i = 0; i < 5; i++) particles.push(new Particle(x, y));
                sCtx.globalCompositeOperation = 'destination-out';
                sCtx.beginPath();
                sCtx.arc(x, y, 18, 0, Math.PI * 2);
                sCtx.fill();
                checkScratchPercent(sCanvas, sCtx);
            }

            function checkScratchPercent(canvas, ctx) {
                if (isRemoved) return;
                const imageData = ctx.getImageData(0, 0, 90, 80);
                const pixels = imageData.data;
                let transparentPixels = 0;
                for (let i = 0; i < pixels.length; i += 4) if (pixels[i + 3] < 150) transparentPixels++;
                
                if ((transparentPixels / (90 * 80)) > 0.55) {
                    isRemoved = true;
                    canvas.style.opacity = '0';
                    clearedCount++;
                    setTimeout(() => canvas.remove(), 400);
                    if (clearedCount === 9) showResult();
                }
            }

            sCanvas.addEventListener('mousedown', () => isDrawing = true);
            sCanvas.addEventListener('touchstart', (e) => { isDrawing = true; e.preventDefault(); });
            window.addEventListener('mouseup', () => isDrawing = false);
            window.addEventListener('touchend', () => isDrawing = false);
            sCanvas.addEventListener('mousemove', scratch);
            sCanvas.addEventListener('touchmove', (e) => { scratch(e); e.preventDefault(); });
        }

        // --- é¡¯ç¤ºçµæœ ---
        function showResult() {
            const emojiEl = document.getElementById('modal-emoji');
            
            if (winner.count === 9) {
                // çµ‚æ¥µè³€è©
                modalText.innerText = superMap[winner.symbol];
                emojiEl.innerText = "ğŸ§§";
            } else {
                // ä¸€èˆ¬è³€è©ï¼šè‡ªå‹•çµ„åˆ "åˆ®ä¸­Nå€‹..."
                modalText.innerText = `åˆ®ä¸­ ${winner.count} å€‹ ${winner.symbol}ï¼Œ${normalMap[winner.symbol]}`;
                emojiEl.innerText = "ğŸŠ";
            }
            
            // å‹•æ…‹åŠ å…¥åˆ†äº«æŒ‰éˆ• (å¦‚æœé‚„æ²’æœ‰çš„è©±)
            if (!document.getElementById('share-btn')) {
                const shareBtn = document.createElement('button');
                shareBtn.id = 'share-btn';
                shareBtn.className = 'modal-btn btn-share';
                shareBtn.innerText = 'åˆ†äº«çµ¦å¥½å‹';
                shareBtn.onclick = sendShare;
                document.getElementById('btn-container').appendChild(shareBtn);
            }
            
            setTimeout(() => { modal.style.display = 'block'; }, 500);
        }

        function closeModal() { initGame(); }

        // å•Ÿå‹•æµç¨‹
        window.onload = function() {
            initializeLiff();
            initGame();
        };
    </script>
</body>
</html>
